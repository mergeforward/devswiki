



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
        <meta name="author" content="Makefile君">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>私有云DevOps持续构建系统的搭建 - DevsWiki</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../../../../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#devops" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../../../.." title="DevsWiki" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              DevsWiki
            </span>
            <span class="md-header-nav__topic">
              
                私有云DevOps持续构建系统的搭建
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../../../.." title="DevsWiki" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    DevsWiki
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      目录
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        目录
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-1" type="checkbox" id="nav-1-1">
    
    <label class="md-nav__link" for="nav-1-1">
      技术博文
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-1-1">
        技术博文
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-1-1" type="checkbox" id="nav-1-1-1">
    
    <label class="md-nav__link" for="nav-1-1-1">
      机器学习相关
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-1-1-1">
        机器学习相关
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-1-1-1" type="checkbox" id="nav-1-1-1-1">
    
    <label class="md-nav__link" for="nav-1-1-1-1">
      安装准备
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-1-1-1-1">
        安装准备
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../ml/cuda_install/" title="tensorflow/pytorch 安装准备" class="md-nav__link">
      tensorflow/pytorch 安装准备
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-1-2" type="checkbox" id="nav-1-1-2">
    
    <label class="md-nav__link" for="nav-1-1-2">
      k8s相关
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-1-1-2">
        k8s相关
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-1-2-1" type="checkbox" id="nav-1-1-2-1">
    
    <label class="md-nav__link" for="nav-1-1-2-1">
      安装准备
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-1-1-2-1">
        安装准备
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../2019/k8s/harbor_install/" title="在k8s上搭建harbor" class="md-nav__link">
      在k8s上搭建harbor
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-1-3" type="checkbox" id="nav-1-1-3">
    
    <label class="md-nav__link" for="nav-1-1-3">
      密码学
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-1-1-3">
        密码学
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-1-3-1" type="checkbox" id="nav-1-1-3-1">
    
    <label class="md-nav__link" for="nav-1-1-3-1">
      消息的通讯
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-1-1-3-1">
        消息的通讯
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../crypt/fun_crypt/" title="现代密码学之消息的通讯" class="md-nav__link">
      现代密码学之消息的通讯
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-2" type="checkbox" id="nav-1-2">
    
    <label class="md-nav__link" for="nav-1-2">
      演讲分享
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-1-2">
        演讲分享
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-2-1" type="checkbox" id="nav-1-2-1">
    
    <label class="md-nav__link" for="nav-1-2-1">
      GDG上海分享
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-1-2-1">
        GDG上海分享
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-2-1-1" type="checkbox" id="nav-1-2-1-1">
    
    <label class="md-nav__link" for="nav-1-2-1-1">
      GDG容器系列课程
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-1-2-1-1">
        GDG容器系列课程
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../slides/gdg-shanghai/k8s/ch01/" title="Docker基础入门" class="md-nav__link">
      Docker基础入门
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../slides/gdg-shanghai/k8s/ch02/" title="Docker知识补全" class="md-nav__link">
      Docker知识补全
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../slides/gdg-shanghai/k8s/ch03/" title="漫谈K8s" class="md-nav__link">
      漫谈K8s
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../slides/gdg-shanghai/k8s/ch04/" title="K8s入门" class="md-nav__link">
      K8s入门
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../slides/gdg-shanghai/k8s/ch05/" title="K8s实战" class="md-nav__link">
      K8s实战
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-2-2" type="checkbox" id="nav-1-2-2">
    
    <label class="md-nav__link" for="nav-1-2-2">
      GDG郑州分享
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-1-2-2">
        GDG郑州分享
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-2-2-1" type="checkbox" id="nav-1-2-2-1">
    
    <label class="md-nav__link" for="nav-1-2-2-1">
      devfest 2019
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-1-2-2-1">
        devfest 2019
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../../slides/gdg-zhengzhou/devfest2019/apifirst/" title="API-First Approach to Building Products" class="md-nav__link">
      API-First Approach to Building Products
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    背景:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    思路分析:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    技术选型：
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    硬件配置
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    解决方案
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#devops_1" class="md-nav__link">
    DevOps流程架构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    部署架构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker" class="md-nav__link">
    Docker的安装
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubectl" class="md-nav__link">
    KubeCtl的安装
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jenkins" class="md-nav__link">
    Jenkins的安装与配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nexus" class="md-nav__link">
    Nexus的安装与配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#k8s-ha" class="md-nav__link">
    K8s 环境搭建（HA）
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    基础配置
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    安装三大件（不是每台机器都需要，但是默认方便，可以无脑安装）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    拉取镜像
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#haproxy" class="md-nav__link">
    haproxy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#heartbeat-vip" class="md-nav__link">
    heartbeat &amp; VIP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#etcd-ha" class="md-nav__link">
    etcd ha
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    配置主节点&amp;从节点
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python" class="md-nav__link">
    python代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dockerfileimage" class="md-nav__link">
    Dockerfile构建Image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    流水线编排文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy" class="md-nav__link">
    deploy模板
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    部署后运行展示
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    可能性改进
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    后记
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="devops">私有云DevOps持续构建系统的搭建</h1>
<p>-- thoughtworks devops面试题解答</p>
<p>author: 孟繁超(dameng/Makefile君)<br />
copyright： 版权所有，如需转载请联系<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#112;&#105;&#110;&#103;&#102;&#48;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">&#112;&#105;&#110;&#103;&#102;&#48;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</a></p>
<h2 id="_1">背景:</h2>
<p>thoughtworks的DevOps的面试题目中的核心要求如下(细节的话暂不方便透露):<br />
  - 提供一个给开发使用的环境<br />
  - 搭建一个CI/CD环境构建相关的制品<br />
  - 通过CI/CD将开发代码部署到相应的环境上</p>
<h2 id="_2">思路分析:</h2>
<p>其中涉及到两块环境的搭建，一个是搭建运行时环境，一个是构建CI/CD系统。同时其也隐性的要求了，编写demo代码，通过CI/CD系统部署到搭建的运行时环境中去。<br />
  所以将任务需求进行拆分<br />
  - CI/CD环境的搭建（包含中间产出制品依赖系统的搭建）<br />
  - 运行时环境的搭建<br />
  - demo代码的编写<br />
  - 流水线的涉及<br />
  - 实际构建部署的展示</p>
<h2 id="_3">技术选型：</h2>
<p>因为是展示性的题目，这里在技术选型上并不会有历史包袱，所以这里选用开源云原生的一套体系进行搭建。<br />
  - 制品统一使用Docker镜像的方式进行流转，运行环境为K8s环境（实际部署使用了HA方案，并部署了istio这样的service mesh框架）<br />
  - CI/CD环境为 Jenkins 2 (通过插件方式实现docker镜像构建与发布以及k8s的部署)<br />
  - 中间制品的存储使用 Nexus 3 （虽然Nexus是一个通用的制品仓库，但是这里重点针对其Docker镜像仓库进行操作）<br />
  - 流水线部分使用jenkinsfile，实现了pipeline as code，并且以模拟的形式区分了开发，测试，生产三套环境（理论上可以更多，但是暂时只选了这三个最基础的环境）<br />
  - demo使用的python的fastapi框架进行搭建，测试部分提供了pytest的测试代码，并原生提供了swagger ui进行在线测试功能，以及redoc页面进行api文档浏览</p>
<h2 id="_4">硬件配置</h2>
<ul>
<li>为了方便Jenkins以及Nexus的搭建在此次提交的作业中并没有放在k8s集群中，而是独立在主机上以docker方式独立启动</li>
<li>主机为我的笔记本电脑 cpu: i7 9750h, 1T硬盘， 64G 内存</li>
<li>k8s运行时环境使用的是最新版本（1.18）的k8s，采用了高可用的部署方案，共耗费了8台kvm虚拟机，每台机器分配2核4G内存，系统为debian 10.4</li>
<li>实际开销为将近40G的内存（截图中为35.7G使用量，实际测试时有到过40G）</li>
</ul>
<p><img alt="" src="../2020-07-19-00-20-27.png" /></p>
<p><img alt="" src="../2020-07-18-13-43-25.png" /></p>
<h2 id="_5">解决方案</h2>
<h3 id="devops_1">DevOps流程架构</h3>
<p>按照峰达整理的相对完备的Devops流程中，应包括如下几个环节</p>
<p><img alt="" src="../2020-07-18-17-48-08.png" /></p>
<p>但是这里因为时间和精力有限，只挑选了其中相对比较重要的环节进行搭建演示</p>
<p><img alt="" src="../2020-07-18-18-24-55.png" /></p>
<p>图中覆盖了CI/CD的核心环节，流水线主要流程涵盖了如下几个环节</p>
<ul>
<li>代码的拉取</li>
<li>镜像的构建</li>
<li>测试与质量</li>
<li>制品的发布</li>
<li>垃圾的清理</li>
<li>制品的部署</li>
<li>数据的展示*（部署istio后自带）</li>
</ul>
<p>同时通过Nexus创建了三个不同的仓库用来区分镜像的环境，而在K8s集群中以不同namespace</p>
<h3 id="_6">部署架构</h3>
<p>为了方便后续描述，这里给出部署节点的架构图</p>
<p><img alt="" src="../2020-07-18-16-21-27.png" /></p>
<p>注意，图中172.19.0.1为宿主机在172.19网段的IP，也可通过127.0.0.1或192.168.31.72(我的外部网络分配的IP)进行访问，后文中如果有相关IP，均指向同一机器</p>
<h3 id="docker">Docker的安装</h3>
<p>卸载旧版</p>
<div class="codehilite"><pre><span></span>sudo apt-get remove docker docker-engine docker.io containerd runc
</pre></div>

<p>配置源</p>
<div class="codehilite"><pre><span></span>sudo apt-get update

sudo apt-get install <span class="se">\</span>
    apt-transport-https <span class="se">\</span>
    ca-certificates <span class="se">\</span>
    curl <span class="se">\</span>
    gnupg-agent <span class="se">\</span>
    software-properties-common

curl -fsSL https://download.docker.com/linux/ubuntu/gpg <span class="p">|</span> sudo apt-key add -

sudo add-apt-repository <span class="se">\</span>
   <span class="s2">&quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu \</span>
<span class="s2">   </span><span class="k">$(</span>lsb_release -cs<span class="k">)</span><span class="s2"> \</span>
<span class="s2">   stable&quot;</span>
</pre></div>

<p>安装docker</p>
<div class="codehilite"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="k">get</span> <span class="k">update</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="k">get</span> <span class="n">install</span> <span class="n">docker</span><span class="o">-</span><span class="n">ce</span> <span class="n">docker</span><span class="o">-</span><span class="n">ce</span><span class="o">-</span><span class="n">cli</span> <span class="n">containerd</span><span class="p">.</span><span class="n">io</span>
</pre></div>

<p>用户组赋能</p>
<div class="codehilite"><pre><span></span>sudo groupadd docker
sudo usermod -aG docker <span class="nv">$USER</span>
</pre></div>

<p>修改配置</p>
<p>修改<code class="codehilite"><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">daemon</span><span class="p">.</span><span class="n">json</span></code>如下</p>
<div class="codehilite"><pre><span></span>{
  <span class="s2">&quot;</span><span class="s">registry-mirrors</span><span class="s2">&quot;</span>: [
    <span class="s2">&quot;</span><span class="s">https://registry.docker-cn.com</span><span class="s2">&quot;</span>, 
    <span class="s2">&quot;</span><span class="s">http://hub-mirror.c.163.com</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">https://docker.mirrors.ustc.edu.cn</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">https://reg-mirror.qiniu.com</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">https://quay.azk8s.cn</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">https://gcr.azk8s.cn</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">https://dockerhub.azk8s.cn</span><span class="s2">&quot;</span>
  ],
  <span class="s2">&quot;</span><span class="s">exec-opts</span><span class="s2">&quot;</span>: [<span class="s2">&quot;</span><span class="s">native.cgroupdriver=systemd</span><span class="s2">&quot;</span>],
  <span class="s2">&quot;</span><span class="s">log-driver</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">json-file</span><span class="s2">&quot;</span>,
  <span class="s2">&quot;</span><span class="s">log-opts</span><span class="s2">&quot;</span>: {
    <span class="s2">&quot;</span><span class="s">max-size</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">100m</span><span class="s2">&quot;</span>
  },
  <span class="s2">&quot;</span><span class="s">insecure-registries</span><span class="s2">&quot;</span>: [<span class="s2">&quot;</span><span class="s">0.0.0.0/0</span><span class="s2">&quot;</span>],
  <span class="s2">&quot;</span><span class="s">storage-driver</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">overlay2</span><span class="s2">&quot;</span>
}
</pre></div>

<p>并重启docker， <code class="codehilite"><span class="n">sudo</span> <span class="n">service</span> <span class="n">docker</span> <span class="k">restart</span></code></p>
<h3 id="kubectl">KubeCtl的安装</h3>
<p>宿主机器上安装kubectl 只是方便操作k8s集群，因为jenkins会用到kubectl，所以这里安装后，可以直接挂载给jenkins使用。</p>
<div class="codehilite"><pre><span></span>apt-get update <span class="o">&amp;&amp;</span> apt-get install -y apt-transport-https
curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span class="p">|</span> apt-key add - 

cat <span class="s">&lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list</span>
<span class="s">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span>
<span class="s">EOF</span>
apt-get update
apt-get install -y kubectl
</pre></div>

<h3 id="jenkins">Jenkins的安装与配置</h3>
<p>在主机上以docker运行Jenkins非常方便，但是要因为要对接docker和k8s</p>
<div class="codehilite"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">dameng</span><span class="o">/</span><span class="n">jenkins</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">jenkins_home</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">docker</span><span class="p">.</span><span class="n">sock</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">docker</span><span class="p">.</span><span class="n">sock</span> <span class="c1">--name jenkins -v $(which docker):/usr/bin/docker -v $(which kubectl):/usr/bin/kubectl --group-add=$(stat -c %g /var/run/docker.sock) -v /home/dameng/jenkins/.docker-jenkins:/.docker -v /home/dameng/jenkins/.kube:/.kube --network host jenkins/jenkins:lts</span>
</pre></div>

<p>要注意:<br />
- 端口8080,50000是必须要暴露的，简单起见这里使用了host网络模式<br />
- 配置文件独立挂载<br />
- 复用宿主机的docker(cli以及unix socket)，kubectl（cli以及kube config配置）</p>
<p>在安装后可通过8080端口进行访问，为了方便和美观选装Blue Ocean UI， Docker Pipeline， Kubernetes CLI等插件</p>
<p>插件安装页面<br />
<img alt="" src="../2020-07-18-16-36-50.png" /></p>
<p>Blue Ocean UI</p>
<p><img alt="" src="../2020-07-18-16-37-36.png" /></p>
<h3 id="nexus">Nexus的安装与配置</h3>
<p>和前面运行Jenkins的方式类似，这里我们也使用docker的方式来运行Nexus</p>
<div class="codehilite"><pre><span></span>docker run -d --network host --name nexus  -v /home/dameng/nexus:/nexus-data sonatype/nexus3
</pre></div>

<p>同样也有些要注意的地方</p>
<ul>
<li>端口8081是必须要暴露的，简单起见这里使用了host网络模式</li>
<li>配置文件独立挂载</li>
</ul>
<p>登陆之后，会生成首次运行用密码，位于容器中<code class="codehilite"><span class="o">/</span><span class="n">nexus</span><span class="o">-</span><span class="k">data</span><span class="o">/</span><span class="k">admin</span><span class="p">.</span><span class="n">password</span></code>文件中，使用其登陆后有UI提示修改密码，修改即可</p>
<p>Nexus支持maven，pip，node，docker registry等多种仓库，本文所讨论的只涉及Docker Registry。另外其还支持host，proxy，group三种模式，可以搭配使用，但这里的方案直接使用host模式的docker registry，分别对应开发，测试，生产环境的镜像仓库。</p>
<p>这里分别将8082,8083规划为dev环境的http和https端口，8084,8085对应开发环境，8086，8087对应生产环境。</p>
<p>另外要注意的是，创建完成后并不能直接login，需要通过realms设置docker bearer token realm，完成授权的管理。</p>
<p><img alt="" src="../2020-07-18-17-41-15.png" /></p>
<h3 id="k8s-ha">K8s 环境搭建（HA）</h3>
<h4 id="_7">基础配置</h4>
<p>除了上面docker的配置以外，为了简便，这里对每台K8s节点进行如下操作</p>
<ul>
<li>确定systemctl管理服务的系统（如debian，ubuntu, fedora）</li>
<li>配置好ssh登陆</li>
<li>开启IpForward</li>
</ul>
<p>编辑<code class="codehilite"><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">conf</span></code>修改</p>
<div class="codehilite"><pre><span></span>net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span>
</pre></div>

<p>然后执行<code class="codehilite"><span class="n">sysctl</span> <span class="c1">--system</span></code><br />
- 关闭swap分区<br />
  编辑 <code class="codehilite"><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fstab</span></code> 注释 和swap相关的行，重启或执行命令<code class="codehilite"><span class="n">swapoff</span> <span class="o">-</span><span class="n">a</span></code></p>
<h5 id="_8">安装三大件（不是每台机器都需要，但是默认方便，可以无脑安装）</h5>
<div class="codehilite"><pre><span></span>apt-get update <span class="o">&amp;&amp;</span> apt-get install -y apt-transport-https
curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span class="p">|</span> apt-key add - 

cat <span class="s">&lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list</span>
<span class="s">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span>
<span class="s">EOF</span>
apt-get update
apt-get install -y kubelet kubeadm kubectl
</pre></div>

<h5 id="_9">拉取镜像</h5>
<p>执行<code class="codehilite"><span class="n">kubeadm</span> <span class="n">config</span> <span class="n">images</span> <span class="n">list</span></code>获得</p>
<div class="codehilite"><pre><span></span>k8s.gcr.io/kube-apiserver:v1.18.6
k8s.gcr.io/kube-controller-manager:v1.18.6
k8s.gcr.io/kube-scheduler:v1.18.6
k8s.gcr.io/kube-proxy:v1.18.6
k8s.gcr.io/pause:3.2
k8s.gcr.io/etcd:3.4.3-0
k8s.gcr.io/coredns:1.6.7
</pre></div>

<p>编辑脚本并执行</p>
<div class="codehilite"><pre><span></span><span class="ch">#! bash</span>

<span class="nv">images</span><span class="o">=(</span>  
kube-apiserver:v1.18.3
kube-controller-manager:v1.18.3
kube-scheduler:v1.18.3
kube-proxy:v1.18.3
pause:3.2
etcd:3.4.3-0
coredns:1.6.7
<span class="o">)</span>

<span class="k">for</span> imageName in <span class="si">${</span><span class="nv">images</span><span class="p">[@]</span><span class="si">}</span> <span class="p">;</span> <span class="k">do</span>
    docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="nv">$imageName</span>
    docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="nv">$imageName</span> k8s.gcr.io/<span class="nv">$imageName</span>
    docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="nv">$imageName</span>
<span class="k">done</span>
</pre></div>

<h4 id="haproxy">haproxy</h4>
<p>42，43节点安装haproxy</p>
<div class="codehilite"><pre><span></span>apt-get update <span class="o">&amp;&amp;</span> apt-get upgrade <span class="o">&amp;&amp;</span> apt-get install -y haproxy 
</pre></div>

<p>编辑 <code class="codehilite"><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">haproxy</span><span class="p">.</span><span class="n">cfg</span></code></p>
<div class="codehilite"><pre><span></span>global
    user haproxy
    group haproxy
defaults
    mode http
    log global
    retries <span class="m">2</span>
    timeout connect 3000ms
    timeout server 5000ms
    timeout client 5000ms
frontend kubernetes
    <span class="nb">bind</span> <span class="m">172</span>.19.0.41:6443,172.19.0.41:30843
    option tcplog
    mode tcp
    default_backend kubernetes-master-nodes
backend kubernetes-master-nodes
    mode tcp
    balance roundrobin
    option tcp-check
    server deb45 <span class="m">172</span>.19.0.45 check fall <span class="m">3</span> rise <span class="m">2</span>
    server deb46 <span class="m">172</span>.19.0.46 check fall <span class="m">3</span> rise <span class="m">2</span>
</pre></div>

<p>修改 <code class="codehilite"><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">conf</span></code> 文件</p>
<div class="codehilite"><pre><span></span>net.ipv4.ip_nonlocal_bind<span class="o">=</span><span class="m">1</span>
</pre></div>

<p>之后执行<code class="codehilite"><span class="n">sysctl</span> <span class="o">-</span><span class="n">p</span></code>，之后执行<code class="codehilite"><span class="n">systemctl</span> <span class="k">start</span> <span class="n">haproxy</span></code></p>
<h4 id="heartbeat-vip">heartbeat &amp; VIP</h4>
<div class="codehilite"><pre><span></span>apt-get -y install heartbeat <span class="o">&amp;&amp;</span> systemctl <span class="nb">enable</span> heartbeat
</pre></div>

<p>生成heartbeat用的key<br />
<div class="codehilite"><pre><span></span><span class="nb">echo</span> -n securepass <span class="p">|</span> md5sum
</pre></div></p>
<p>将生成的类似如下内容写入 <code class="codehilite"><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ha</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">authkeys</span></code>， 并修改权限 <code class="codehilite"><span class="n">chmod</span> <span class="mi">600</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ha</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">authkeys</span></code><br />
<div class="codehilite"><pre><span></span><span class="n">aba7d0d3b3f239fa5db79bdf27b4d19z</span>
</pre></div></p>
<p>配置heartbeat</p>
<p>在<code class="codehilite"><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ha</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">ha</span><span class="p">.</span><span class="n">cf</span></code>添加heartbeat所在的节点</p>
<div class="codehilite"><pre><span></span>node deb42 deb43
</pre></div>

<p>其中deb42，deb43在<code class="codehilite"><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span></code>配置成了.42和.43的节点</p>
<p>配置<code class="codehilite"><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ha</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">haresources</span></code></p>
<p>.42节点配置成</p>
<div class="codehilite"><pre><span></span>deb42 <span class="m">172</span>.19.0.41
</pre></div>

<p>.43节点配置成<br />
<div class="codehilite"><pre><span></span>deb43 <span class="m">172</span>.19.0.41
</pre></div></p>
<p>之后重启heartbeat, <code class="codehilite"><span class="n">systemctl</span> <span class="k">restart</span> <span class="n">heartbeat</span></code></p>
<h4 id="etcd-ha">etcd ha</h4>
<p>下面配置需要在bash下运行<br />
<div class="codehilite"><pre><span></span><span class="nb">export</span> <span class="nv">HOST0</span><span class="o">=</span><span class="m">172</span>.19.0.42
<span class="nb">export</span> <span class="nv">HOST1</span><span class="o">=</span><span class="m">172</span>.19.0.43
<span class="nb">export</span> <span class="nv">HOST2</span><span class="o">=</span><span class="m">172</span>.19.0.44

mkdir -p /tmp/<span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>/ /tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/ /tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/
<span class="nv">ETCDHOSTS</span><span class="o">=(</span><span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span> <span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span> <span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span><span class="o">)</span>
<span class="nv">NAMES</span><span class="o">=(</span><span class="s2">&quot;infra0&quot;</span> <span class="s2">&quot;infra1&quot;</span> <span class="s2">&quot;infra2&quot;</span><span class="o">)</span>

<span class="k">for</span> i in <span class="s2">&quot;</span><span class="si">${</span><span class="p">!ETCDHOSTS[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
<span class="nv">HOST</span><span class="o">=</span><span class="si">${</span><span class="nv">ETCDHOSTS</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="si">}</span>
<span class="nv">NAME</span><span class="o">=</span><span class="si">${</span><span class="nv">NAMES</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="si">}</span>
cat <span class="s">&lt;&lt; EOF &gt; /tmp/${HOST}/kubeadmcfg.yaml</span>
<span class="s">apiVersion: &quot;kubeadm.k8s.io/v1beta1&quot;</span>
<span class="s">kind: ClusterConfiguration</span>
<span class="s">etcd:</span>
<span class="s">    local:</span>
<span class="s">        serverCertSANs:</span>
<span class="s">        - &quot;${HOST}&quot;</span>
<span class="s">        peerCertSANs:</span>
<span class="s">        - &quot;${HOST}&quot;</span>
<span class="s">        extraArgs:</span>
<span class="s">            initial-cluster: ${NAMES[0]}=https://${ETCDHOSTS[0]}:2380,${NAMES[1]}=https://${ETCDHOSTS[1]}:2380,${NAMES[2]}=https://${ETCDHOSTS[2]}:2380</span>
<span class="s">            initial-cluster-state: new</span>
<span class="s">            name: ${NAME}</span>
<span class="s">            listen-peer-urls: https://${HOST}:2380</span>
<span class="s">            listen-client-urls: https://${HOST}:2379</span>
<span class="s">            advertise-client-urls: https://${HOST}:2379</span>
<span class="s">            initial-advertise-peer-urls: https://${HOST}:2380</span>
<span class="s">EOF</span>
<span class="k">done</span>
</pre></div></p>
<p>之后，<code class="codehilite"><span class="n">kubeadm</span> <span class="n">init</span> <span class="n">phase</span> <span class="n">certs</span> <span class="n">etcd</span><span class="o">-</span><span class="n">ca</span></code>生成ca.crt和ca.key</p>
<p>生成证书<br />
<div class="codehilite"><pre><span></span>kubeadm init phase certs etcd-server --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>/kubeadmcfg.yaml<span class="sb">`</span>
kubeadm init phase certs etcd-peer --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>/kubeadmcfg.yaml
kubeadm init phase certs etcd-healthcheck-client --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>/kubeadmcfg.yaml
kubeadm init phase certs apiserver-etcd-client --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>/kubeadmcfg.yaml
cp -R /etc/kubernetes/pki /tmp/<span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>/

kubeadm init phase certs etcd-server --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/kubeadmcfg.yaml<span class="sb">`</span>
kubeadm init phase certs etcd-peer --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/kubeadmcfg.yaml
kubeadm init phase certs etcd-healthcheck-client --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/kubeadmcfg.yaml
kubeadm init phase certs apiserver-etcd-client --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/kubeadmcfg.yaml
cp -R /etc/kubernetes/pki /tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/

kubeadm init phase certs etcd-server --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/kubeadmcfg.yaml<span class="sb">`</span>
kubeadm init phase certs etcd-peer --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/kubeadmcfg.yaml
kubeadm init phase certs etcd-healthcheck-client --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/kubeadmcfg.yaml
kubeadm init phase certs apiserver-etcd-client --config<span class="o">=</span>/tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/kubeadmcfg.yaml
cp -R /etc/kubernetes/pki /tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/
</pre></div></p>
<p>按需拷贝<br />
<div class="codehilite"><pre><span></span>scp -r /tmp/<span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>/* <span class="si">${</span><span class="nv">HOST0</span><span class="si">}</span>:
scp -r /tmp/<span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>/* <span class="si">${</span><span class="nv">HOST1</span><span class="si">}</span>:
scp -r /tmp/<span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>/* <span class="si">${</span><span class="nv">HOST2</span><span class="si">}</span>:
</pre></div></p>
<p>在42，43，44节点上执行<br />
<div class="codehilite"><pre><span></span><span class="nb">cd</span> /root
mv pki /etc/kubernetes/
</pre></div></p>
<p>整体节点目录为</p>
<div class="codehilite"><pre><span></span>/root
└── kubeadmcfg.yaml
---
/etc/kubernetes/pki
├── apiserver-etcd-client.crt
├── apiserver-etcd-client.key
└── etcd
    ├── ca.crt
    ├── healthcheck-client.crt
    ├── healthcheck-client.key
    ├── peer.crt
    ├── peer.key
    ├── server.crt
    └── server.key
</pre></div>

<p>42,43,44分别执行</p>
<div class="codehilite"><pre><span></span>kubeadm init phase etcd <span class="nb">local</span> --config<span class="o">=</span>/tmp/172.19.0.42/kubeadmcfg.yaml
kubeadm init phase etcd <span class="nb">local</span> --config<span class="o">=</span>/tmp/172.19.0.43/kubeadmcfg.yaml
kubeadm init phase etcd <span class="nb">local</span> --config<span class="o">=</span>/tmp/172.19.0.44/kubeadmcfg.yaml
</pre></div>

<h4 id="_10">配置主节点&amp;从节点</h4>
<p>先配置45节点， 拷贝etcd证书到45主节点</p>
<div class="codehilite"><pre><span></span>scp /etc/kubernetes/pki/etcd/ca.crt <span class="m">172</span>.19.0.45:
scp /etc/kubernetes/pki/apiserver-etcd-client.crt <span class="m">172</span>.19.0.45:
scp /etc/kubernetes/pki/apiserver-etcd-client.key <span class="m">172</span>.19.0.45:
</pre></div>

<p>编辑kubeadm-config.yaml</p>
<div class="codehilite"><pre><span></span>apiVersion: kubeadm.k8s.io/v1beta1
kind: ClusterConfiguration
kubernetesVersion: stable
apiServer:
  certSANs:
  - <span class="s2">&quot;172.19.0.41&quot;</span>
controlPlaneEndpoint: <span class="s2">&quot;172.19.0.41:6443&quot;</span>
etcd:
    external:
        endpoints:
        - https://172.19.0.42:2379
        - https://172.19.0.43:2379
        - https://172.19.0.44:2379
        caFile: /etc/kubernetes/pki/etcd/ca.crt
        certFile: /etc/kubernetes/pki/apiserver-etcd-client.crt
        keyFile: /etc/kubernetes/pki/apiserver-etcd-client.key
</pre></div>

<p>拷贝证书</p>
<div class="codehilite"><pre><span></span>mkdir -p /etc/kubernetes/pki/etcd/ 
cp /root/ca.crt /etc/kubernetes/pki/etcd/
cp /root/apiserver-etcd-client.crt /etc/kubernetes/pki/
cp /root/apiserver-etcd-client.key /etc/kubernetes/pki/
</pre></div>

<p>kubeadm初始化</p>
<div class="codehilite"><pre><span></span>kubeadm init --config kubeadm-config.yaml
</pre></div>

<p>再配置46节点，在45节点上执行</p>
<div class="codehilite"><pre><span></span>scp /etc/kubernetes/pki/ca.crt <span class="m">172</span>.19.0.46:
scp /etc/kubernetes/pki/ca.key <span class="m">172</span>.19.0.46:
scp /etc/kubernetes/pki/sa.key <span class="m">172</span>.19.0.46:
scp /etc/kubernetes/pki/sa.pub <span class="m">172</span>.19.0.46:
scp /etc/kubernetes/pki/front-proxy-ca.crt @172.19.0.46:
scp /etc/kubernetes/pki/front-proxy-ca.key @172.19.0.46:
scp /etc/kubernetes/pki/apiserver-etcd-client.crt @172.19.0.46:
scp /etc/kubernetes/pki/apiserver-etcd-client.key @172.19.0.46:
scp /etc/kubernetes/pki/etcd/ca.crt <span class="m">172</span>.19.0.46:etcd-ca.crt
scp /etc/kubernetes/admin.conf <span class="m">172</span>.19.0.46:
</pre></div>

<p>再在46节点上</p>
<div class="codehilite"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">etcd</span>
<span class="n">mv</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ca</span><span class="p">.</span><span class="n">crt</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span>
<span class="n">mv</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ca</span><span class="p">.</span><span class="k">key</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span>
<span class="n">mv</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">sa</span><span class="p">.</span><span class="n">pub</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span>
<span class="n">mv</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">sa</span><span class="p">.</span><span class="k">key</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span>
<span class="n">mv</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">apiserver</span><span class="o">-</span><span class="n">etcd</span><span class="o">-</span><span class="n">client</span><span class="p">.</span><span class="n">crt</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span> 
<span class="n">mv</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">apiserver</span><span class="o">-</span><span class="n">etcd</span><span class="o">-</span><span class="n">client</span><span class="p">.</span><span class="k">key</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span>
<span class="n">mv</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">front</span><span class="o">-</span><span class="n">proxy</span><span class="o">-</span><span class="n">ca</span><span class="p">.</span><span class="n">crt</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span>
<span class="n">mv</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">front</span><span class="o">-</span><span class="n">proxy</span><span class="o">-</span><span class="n">ca</span><span class="p">.</span><span class="k">key</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span>
<span class="n">mv</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">etcd</span><span class="o">-</span><span class="n">ca</span><span class="p">.</span><span class="n">crt</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">etcd</span><span class="o">/</span><span class="n">ca</span><span class="p">.</span><span class="n">crt</span>
<span class="n">mv</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="k">admin</span><span class="p">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="k">admin</span><span class="p">.</span><span class="n">conf</span>
</pre></div>

<p>46以主节点方式加入ha集群，注意其中token为前面45节点初始化时的回显中的信息<br />
<div class="codehilite"><pre><span></span><span class="n">kubeadm</span> <span class="k">join</span> <span class="mi">172</span><span class="p">.</span><span class="mi">19</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">41</span><span class="p">:</span><span class="mi">6443</span> <span class="c1">--token xxx.yyy --discovery-token-ca-cert-hash sha256:zzz --control-plane</span>
</pre></div></p>
<p>47，48，49以worker节点方式加入, 分别执行, 注意没有--control-plane的选项<br />
<div class="codehilite"><pre><span></span><span class="n">kubeadm</span> <span class="k">join</span> <span class="mi">172</span><span class="p">.</span><span class="mi">19</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">41</span><span class="p">:</span><span class="mi">6443</span> <span class="c1">--token xxx.yyy --discovery-token-ca-cert-hash sha256:zzz </span>
</pre></div></p>
<p>注意为了保障网络畅通，还要确保安装了CNI网络插件，这里选用Calico，其安装方式为</p>
<div class="codehilite"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">docs</span><span class="p">.</span><span class="n">projectcalico</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">v3</span><span class="p">.</span><span class="mi">14</span><span class="o">/</span><span class="n">manifests</span><span class="o">/</span><span class="n">calico</span><span class="p">.</span><span class="n">yaml</span>
</pre></div>

<h3 id="python">python代码</h3>
<p>这里使用fastapi构建一套简单的api，为了简便，数据库部分使用内存对象来mock</p>
<p>编辑main.py文件</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Header</span><span class="p">,</span> <span class="n">HTTPException</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="n">fake_secret_token</span> <span class="o">=</span> <span class="s2">&quot;coneofsilence&quot;</span>

<span class="n">fake_db</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;foo&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;There goes my hero&quot;</span><span class="p">},</span>
    <span class="s2">&quot;bar&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Bar&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;The bartenders&quot;</span><span class="p">},</span>
<span class="p">}</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>


<span class="nd">@app.get</span><span class="p">(</span><span class="s2">&quot;/items/{item_id}&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">Item</span><span class="p">)</span>
<span class="n">async</span> <span class="k">def</span> <span class="nf">read_main</span><span class="p">(</span><span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">x_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="o">...</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">x_token</span> <span class="o">!=</span> <span class="n">fake_secret_token</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid X-Token header&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">item_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fake_db</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Item not found&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fake_db</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span>


<span class="nd">@app.post</span><span class="p">(</span><span class="s2">&quot;/items/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">Item</span><span class="p">)</span>
<span class="n">async</span> <span class="k">def</span> <span class="nf">create_item</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">,</span> <span class="n">x_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="o">...</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">x_token</span> <span class="o">!=</span> <span class="n">fake_secret_token</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid X-Token header&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">fake_db</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Item already exists&quot;</span><span class="p">)</span>
    <span class="n">fake_db</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
    <span class="k">return</span> <span class="n">item</span>
</pre></div>

<p>对应的test测试为</p>
<p>编辑test_main.py</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">fastapi.testclient</span> <span class="kn">import</span> <span class="n">TestClient</span>

<span class="kn">from</span> <span class="nn">main</span> <span class="kn">import</span> <span class="n">app</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_read_item</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/items/foo&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;X-Token&quot;</span><span class="p">:</span> <span class="s2">&quot;coneofsilence&quot;</span><span class="p">})</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;There goes my hero&quot;</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">test_read_item_bad_token</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/items/foo&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;X-Token&quot;</span><span class="p">:</span> <span class="s2">&quot;hailhydra&quot;</span><span class="p">})</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid X-Token header&quot;</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">test_read_inexistent_item</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/items/baz&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;X-Token&quot;</span><span class="p">:</span> <span class="s2">&quot;coneofsilence&quot;</span><span class="p">})</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Item not found&quot;</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">test_create_item</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;/items/&quot;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;X-Token&quot;</span><span class="p">:</span> <span class="s2">&quot;coneofsilence&quot;</span><span class="p">},</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo Bar&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;The Foo Barters&quot;</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo Bar&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;The Foo Barters&quot;</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">test_create_item_bad_token</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;/items/&quot;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;X-Token&quot;</span><span class="p">:</span> <span class="s2">&quot;hailhydra&quot;</span><span class="p">},</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;bazz&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Bazz&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Drop the bazz&quot;</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid X-Token header&quot;</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">test_create_existing_item</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;/items/&quot;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;X-Token&quot;</span><span class="p">:</span> <span class="s2">&quot;coneofsilence&quot;</span><span class="p">},</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;The Foo ID Stealers&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;There goes my stealer&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Item already exists&quot;</span><span class="p">}</span>
</pre></div>

<p>程序运行方式为<code class="codehilite"><span class="n">uvicorn</span> <span class="n">main</span><span class="p">:</span><span class="n">app</span> <span class="c1">--reload</span></code>, 测试运行方式为<code class="codehilite"><span class="n">pytest</span> <span class="o">-</span><span class="n">v</span> <span class="n">test_main</span><span class="p">.</span><span class="n">py</span></code></p>
<p>依赖文件requirements.txt<br />
<div class="codehilite"><pre><span></span><span class="n">attrs</span><span class="o">==</span><span class="mf">19.3</span><span class="o">.</span><span class="mi">0</span>
<span class="n">certifi</span><span class="o">==</span><span class="mf">2020.6</span><span class="o">.</span><span class="mi">20</span>
<span class="n">chardet</span><span class="o">==</span><span class="mf">3.0</span><span class="o">.</span><span class="mi">4</span>
<span class="n">click</span><span class="o">==</span><span class="mf">7.1</span><span class="o">.</span><span class="mi">2</span>
<span class="n">fastapi</span><span class="o">==</span><span class="mf">0.58</span><span class="o">.</span><span class="mi">1</span>
<span class="n">flake8</span><span class="o">==</span><span class="mf">3.8</span><span class="o">.</span><span class="mi">3</span>
<span class="n">h11</span><span class="o">==</span><span class="mf">0.9</span><span class="o">.</span><span class="mi">0</span>
<span class="n">httptools</span><span class="o">==</span><span class="mf">0.1</span><span class="o">.</span><span class="mi">1</span>
<span class="n">idna</span><span class="o">==</span><span class="mf">2.10</span>
<span class="n">mccabe</span><span class="o">==</span><span class="mf">0.6</span><span class="o">.</span><span class="mi">1</span>
<span class="n">more</span><span class="o">-</span><span class="n">itertools</span><span class="o">==</span><span class="mf">8.4</span><span class="o">.</span><span class="mi">0</span>
<span class="n">packaging</span><span class="o">==</span><span class="mf">20.4</span>
<span class="n">pluggy</span><span class="o">==</span><span class="mf">0.13</span><span class="o">.</span><span class="mi">1</span>
<span class="n">py</span><span class="o">==</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span>
<span class="n">pycodestyle</span><span class="o">==</span><span class="mf">2.6</span><span class="o">.</span><span class="mi">0</span>
<span class="n">pydantic</span><span class="o">==</span><span class="mf">1.6</span><span class="o">.</span><span class="mi">1</span>
<span class="n">pyflakes</span><span class="o">==</span><span class="mf">2.2</span><span class="o">.</span><span class="mi">0</span>
<span class="n">pyparsing</span><span class="o">==</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">7</span>
<span class="n">pytest</span><span class="o">==</span><span class="mf">5.4</span><span class="o">.</span><span class="mi">3</span>
<span class="n">requests</span><span class="o">==</span><span class="mf">2.24</span><span class="o">.</span><span class="mi">0</span>
<span class="n">six</span><span class="o">==</span><span class="mf">1.15</span><span class="o">.</span><span class="mi">0</span>
<span class="n">starlette</span><span class="o">==</span><span class="mf">0.13</span><span class="o">.</span><span class="mi">4</span>
<span class="n">urllib3</span><span class="o">==</span><span class="mf">1.25</span><span class="o">.</span><span class="mi">9</span>
<span class="n">uvicorn</span><span class="o">==</span><span class="mf">0.11</span><span class="o">.</span><span class="mi">5</span>
<span class="n">uvloop</span><span class="o">==</span><span class="mf">0.14</span><span class="o">.</span><span class="mi">0</span>
<span class="n">wcwidth</span><span class="o">==</span><span class="mf">0.2</span><span class="o">.</span><span class="mi">5</span>
<span class="n">websockets</span><span class="o">==</span><span class="mf">8.1</span>
</pre></div></p>
<h3 id="dockerfileimage">Dockerfile构建Image</h3>
<div class="codehilite"><pre><span></span><span class="k">FROM</span><span class="s"> python:3.8-slim</span>
<span class="k">WORKDIR</span><span class="s"> /opt/app</span>
<span class="k">copy</span> ./ /opt/app
<span class="k">RUN</span> pip3 install --no-cache-dir -r /opt/app/requirements.txt -i https://mirrors.aliyun.com/pypi/simple/ 
<span class="k">ENV</span> PYTHONPATH /opt/app
<span class="k">CMD</span> <span class="p">[</span><span class="s2">&quot;uvicorn&quot;</span><span class="p">,</span>  <span class="s2">&quot;main:app&quot;</span><span class="p">,</span> <span class="s2">&quot;--host&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">]</span>
</pre></div>

<p>镜像基于python3.8的slim(debian)版作为基础镜像</p>
<h3 id="_11">流水线编排文件</h3>
<p>因为Jenkins的默认配置，我们可以以groovy定制的DSL来编写流水线</p>
<p><img alt="" src="../2020-07-18-23-48-39.png" /></p>
<p>编辑Jenkinsfile</p>
<div class="codehilite"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
  <span class="n">agent</span> <span class="n">any</span>
  <span class="n">stages</span> <span class="o">{</span>
    <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Cloning Git&#39;</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">steps</span> <span class="o">{</span>
        <span class="n">git</span> <span class="s1">&#39;https://github.com/pingf/hello-world-fastapi.git&#39;</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Building image&#39;</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">steps</span> <span class="o">{</span>
        <span class="n">script</span> <span class="o">{</span>
          <span class="n">dockerImage</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="na">build</span> <span class="n">imageName</span> <span class="o">+</span> <span class="s2">&quot;:$BUILD_NUMBER&quot;</span>
        <span class="o">}</span>

      <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Run Test&#39;</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">steps</span> <span class="o">{</span>
        <span class="n">script</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">&quot;docker run --rm &quot;</span> <span class="o">+</span> <span class="n">imageName</span> <span class="o">+</span> <span class="s2">&quot;:$BUILD_NUMBER pytest -v&quot;</span>
        <span class="o">}</span>

      <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Run Flake&#39;</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">steps</span> <span class="o">{</span>
        <span class="n">script</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">&quot;docker run --rm &quot;</span> <span class="o">+</span> <span class="n">imageName</span> <span class="o">+</span> <span class="s2">&quot;:$BUILD_NUMBER flake8 main.py&quot;</span>
        <span class="o">}</span>

      <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Publishing Image&#39;</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">parallel</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Publishing Image&#39;</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">steps</span> <span class="o">{</span>
            <span class="n">script</span> <span class="o">{</span>
              <span class="n">docker</span><span class="o">.</span><span class="na">withRegistry</span><span class="o">(</span><span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="n">registry</span><span class="o">,</span> <span class="n">registryCred</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">dockerImage</span><span class="o">.</span><span class="na">push</span><span class="o">()</span>
              <span class="o">}</span>
            <span class="o">}</span>

          <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;publish to test registry&#39;</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">steps</span> <span class="o">{</span>
            <span class="n">script</span> <span class="o">{</span>
              <span class="n">docker</span><span class="o">.</span><span class="na">withRegistry</span><span class="o">(</span><span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="n">registryTest</span><span class="o">,</span> <span class="n">registryCred</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">dockerImage</span><span class="o">.</span><span class="na">push</span><span class="o">()</span>
              <span class="o">}</span>
            <span class="o">}</span>

          <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;publish to prod registry&#39;</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">steps</span> <span class="o">{</span>
            <span class="n">script</span> <span class="o">{</span>
              <span class="n">docker</span><span class="o">.</span><span class="na">withRegistry</span><span class="o">(</span><span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="n">registryProd</span><span class="o">,</span> <span class="n">registryCred</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">dockerImage</span><span class="o">.</span><span class="na">push</span><span class="o">()</span>
              <span class="o">}</span>
            <span class="o">}</span>

          <span class="o">}</span>
        <span class="o">}</span>

      <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Clean Local Image&#39;</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">steps</span> <span class="o">{</span>
        <span class="n">script</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">&quot;docker rmi &quot;</span> <span class="o">+</span> <span class="n">registry</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">imageName</span> <span class="o">+</span> <span class="s2">&quot;:$BUILD_NUMBER&quot;</span>
        <span class="o">}</span>

      <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Deploy&#39;</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">parallel</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;deploy to dev&#39;</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">steps</span> <span class="o">{</span>
            <span class="n">script</span> <span class="o">{</span>
              <span class="n">withKubeConfig</span><span class="o">([</span>
                <span class="nl">credentialsId:</span> <span class="s1">&#39;MYKUBE&#39;</span><span class="o">,</span>
                <span class="nl">serverUrl:</span> <span class="s1">&#39;https://172.19.0.41:6443&#39;</span><span class="o">,</span>
                <span class="nl">namespace:</span> <span class="s1">&#39;twwork&#39;</span>
              <span class="o">])</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s1">&#39;cat deploy.yaml  | sed -e &quot;s/\\\${name}/&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;/g&quot; | sed -e &quot;s/\\\${port}/&#39;</span><span class="o">+</span><span class="n">port</span><span class="o">+</span><span class="s1">&#39;/g&quot; | sed -e &quot;s/\\\${namespace}/&#39;</span><span class="o">+</span><span class="n">namespace</span><span class="o">+</span><span class="s1">&#39;/g&quot; | sed -e &quot;s/\\\${registry}/&#39;</span><span class="o">+</span><span class="n">registry</span><span class="o">+</span><span class="s1">&#39;/g&quot; | sed -e &quot;s/\\\${version}/&#39;</span><span class="o">+</span><span class="s2">&quot;$BUILD_NUMBER&quot;</span><span class="o">+</span><span class="s1">&#39;/g&quot; &gt;&gt; twdeploy.yaml&#39;</span>
                <span class="n">sh</span> <span class="s1">&#39;cat twdeploy.yaml&#39;</span>
                <span class="n">sh</span> <span class="s1">&#39;kubectl apply -f twdeploy.yaml&#39;</span>
              <span class="o">}</span>
            <span class="o">}</span>

          <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;deploy to test&#39;</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">steps</span> <span class="o">{</span>
            <span class="n">input</span> <span class="s1">&#39;Deploy to test?&#39;</span>
            <span class="n">script</span> <span class="o">{</span>
              <span class="n">withKubeConfig</span><span class="o">([</span>
                <span class="nl">credentialsId:</span> <span class="s1">&#39;MYKUBE&#39;</span><span class="o">,</span>
                <span class="nl">serverUrl:</span> <span class="s1">&#39;https://172.19.0.41:6443&#39;</span><span class="o">,</span>
                <span class="nl">namespace:</span> <span class="s1">&#39;twwork&#39;</span>
              <span class="o">])</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s1">&#39;cat deploy.yaml  | sed -e &quot;s/\\\${name}/&#39;</span><span class="o">+</span><span class="n">nameTest</span><span class="o">+</span><span class="s1">&#39;/g&quot; | sed -e &quot;s/\\\${port}/&#39;</span><span class="o">+</span><span class="n">portTest</span><span class="o">+</span><span class="s1">&#39;/g&quot; | sed -e &quot;s/\\\${namespace}/&#39;</span><span class="o">+</span><span class="n">namespace</span><span class="o">+</span><span class="s1">&#39;/g&quot; | sed -e &quot;s/\\\${registry}/&#39;</span><span class="o">+</span><span class="n">registry</span><span class="o">+</span><span class="s1">&#39;/g&quot; | sed -e &quot;s/\\\${version}/&#39;</span><span class="o">+</span><span class="s2">&quot;$BUILD_NUMBER&quot;</span><span class="o">+</span><span class="s1">&#39;/g&quot; &gt;&gt; twdeploy-test.yaml&#39;</span>
                <span class="n">sh</span> <span class="s1">&#39;cat twdeploy-test.yaml&#39;</span>
                <span class="n">sh</span> <span class="s1">&#39;kubectl apply -f twdeploy-test.yaml&#39;</span>
              <span class="o">}</span>
            <span class="o">}</span>

          <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;deploy to prod&#39;</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">steps</span> <span class="o">{</span>
            <span class="n">input</span> <span class="s1">&#39;Deploy to prod?&#39;</span>
            <span class="n">script</span> <span class="o">{</span>
              <span class="n">withKubeConfig</span><span class="o">([</span>
                <span class="nl">credentialsId:</span> <span class="s1">&#39;MYKUBE&#39;</span><span class="o">,</span>
                <span class="nl">serverUrl:</span> <span class="s1">&#39;https://172.19.0.41:6443&#39;</span><span class="o">,</span>
                <span class="nl">namespace:</span> <span class="s1">&#39;twwork&#39;</span>
              <span class="o">])</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s1">&#39;cat deploy.yaml  | sed -e &quot;s/\\\${name}/&#39;</span><span class="o">+</span><span class="n">nameProd</span><span class="o">+</span><span class="s1">&#39;/g&quot; | sed -e &quot;s/\\\${port}/&#39;</span><span class="o">+</span><span class="n">portProd</span><span class="o">+</span><span class="s1">&#39;/g&quot; | sed -e &quot;s/\\\${namespace}/&#39;</span><span class="o">+</span><span class="n">namespace</span><span class="o">+</span><span class="s1">&#39;/g&quot; | sed -e &quot;s/\\\${registry}/&#39;</span><span class="o">+</span><span class="n">registry</span><span class="o">+</span><span class="s1">&#39;/g&quot; | sed -e &quot;s/\\\${version}/&#39;</span><span class="o">+</span><span class="s2">&quot;$BUILD_NUMBER&quot;</span><span class="o">+</span><span class="s1">&#39;/g&quot; &gt;&gt; twdeploy-prod.yaml&#39;</span>
                <span class="n">sh</span> <span class="s1">&#39;cat twdeploy-prod.yaml&#39;</span>
                <span class="n">sh</span> <span class="s1">&#39;kubectl apply -f twdeploy-prod.yaml&#39;</span>
              <span class="o">}</span>
            <span class="o">}</span>

          <span class="o">}</span>
        <span class="o">}</span>

      <span class="o">}</span>
    <span class="o">}</span>

  <span class="o">}</span>
  <span class="n">environment</span> <span class="o">{</span>
    <span class="n">registry</span> <span class="o">=</span> <span class="s1">&#39;172.19.0.1:8082&#39;</span>
    <span class="n">registryTest</span> <span class="o">=</span> <span class="s1">&#39;172.19.0.1:8084&#39;</span>
    <span class="n">registryProd</span> <span class="o">=</span> <span class="s1">&#39;172.19.0.1:8086&#39;</span>
    <span class="n">imageName</span> <span class="o">=</span> <span class="s1">&#39;meng/helloworld-fastapi&#39;</span>
    <span class="n">registryCred</span> <span class="o">=</span> <span class="s1">&#39;DOCKER_CRED&#39;</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>
    <span class="n">namespaceTest</span> <span class="o">=</span> <span class="s1">&#39;twtest&#39;</span>
    <span class="n">namespaceProd</span> <span class="o">=</span> <span class="s1">&#39;twprod&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;demo&#39;</span>
    <span class="n">nameTest</span> <span class="o">=</span> <span class="s1">&#39;demo-test&#39;</span>
    <span class="n">nameProd</span> <span class="o">=</span> <span class="s1">&#39;demo-prod&#39;</span>
    <span class="n">port</span> <span class="o">=</span> <span class="s1">&#39;30081&#39;</span>
    <span class="n">portTest</span> <span class="o">=</span> <span class="s1">&#39;30082&#39;</span>
    <span class="n">portProd</span> <span class="o">=</span> <span class="s1">&#39;30083&#39;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>当我们打开Jenkins的Blue Ocean UI，可以通过构建，看到具体的流水线的形态</p>
<p><img alt="" src="../2020-07-18-23-50-16.png" /></p>
<p>其中deploy to test和deploy to prod为手动确认阶段，其它为自动阶段</p>
<p>另外向多个环境publish image为并行处理阶段</p>
<p>要注意两点</p>
<div class="codehilite"><pre><span></span><span class="n">docker</span><span class="o">.</span><span class="na">withRegistry</span><span class="o">(</span><span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="n">registry</span><span class="o">,</span> <span class="n">registryCred</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">dockerImage</span><span class="o">.</span><span class="na">push</span><span class="o">()</span>
<span class="o">}</span>
</pre></div>

<p>以及</p>
<div class="codehilite"><pre><span></span><span class="n">withKubeConfig</span><span class="o">([</span>
  <span class="nl">credentialsId:</span> <span class="s1">&#39;MYKUBE&#39;</span><span class="o">,</span>
  <span class="nl">serverUrl:</span> <span class="s1">&#39;https://172.19.0.41:6443&#39;</span><span class="o">,</span>
  <span class="nl">namespace:</span> <span class="s1">&#39;twwork&#39;</span>
<span class="o">])</span> <span class="o">{</span>
  <span class="n">sh</span> <span class="s1">&#39;cat deploy.yaml  | sed -e &quot;s/\\\${name}/&#39;</span><span class="o">+</span><span class="n">nameTest</span><span class="o">+</span><span class="s1">&#39;/g&quot; | sed -e &quot;s/\\\${port}/&#39;</span><span class="o">+</span><span class="n">portTest</span><span class="o">+</span><span class="s1">&#39;/g&quot; | sed -e &quot;s/\\\${namespace}/&#39;</span><span class="o">+</span><span class="n">namespace</span><span class="o">+</span><span class="s1">&#39;/g&quot; | sed -e &quot;s/\\\${registry}/&#39;</span><span class="o">+</span><span class="n">registry</span><span class="o">+</span><span class="s1">&#39;/g&quot; | sed -e &quot;s/\\\${version}/&#39;</span><span class="o">+</span><span class="s2">&quot;$BUILD_NUMBER&quot;</span><span class="o">+</span><span class="s1">&#39;/g&quot; &gt;&gt; twdeploy-test.yaml&#39;</span>
  <span class="n">sh</span> <span class="s1">&#39;cat twdeploy-test.yaml&#39;</span>
  <span class="n">sh</span> <span class="s1">&#39;kubectl apply -f twdeploy-test.yaml&#39;</span>
<span class="o">}</span>
</pre></div>

<p>这两段代码为了保证安全性，使用了jenkins的credential机制，且分别为user/password和secret file形式添加</p>
<p><img alt="" src="../2020-07-18-23-55-30.png" /></p>
<p>另外在调用kubectl apply时，为了将jenkins构建时的参数动态传入，使用sed进行模板替换</p>
<h3 id="deploy">deploy模板</h3>
<div class="codehilite"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${name}</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${name}</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${namespace}</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${name}</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
      <span class="nt">labels</span><span class="p">:</span>
        <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${name}</span>
    <span class="nt">spec</span><span class="p">:</span>
      <span class="nt">containers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${name}</span>
        <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${registry}/meng/helloworld-fastapi:${version}</span>
        <span class="nt">ports</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">containerPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8000</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${name}</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${namespace}</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">ports</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
    <span class="nt">nodePort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${port}</span>
    <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8000</span>
    <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
    <span class="nt">targetPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8000</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${name}</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NodePort</span>
</pre></div>

<h3 id="_12">部署后运行展示</h3>
<p>因为使用李NodePort对外暴露，以dev环境为例</p>
<p>我们访问<code class="codehilite"><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mi">172</span><span class="p">.</span><span class="mi">19</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">45</span><span class="p">:</span><span class="mi">30081</span><span class="o">/</span><span class="n">docs</span></code>, 可以通过swagger的try it out界面进行手工测试</p>
<p><img alt="" src="../2020-07-19-00-00-25.png" /></p>
<p>也可通过<code class="codehilite"><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mi">172</span><span class="p">.</span><span class="mi">19</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">45</span><span class="p">:</span><span class="mi">30081</span><span class="o">/</span><span class="n">redoc</span></code> 更好的观看文档</p>
<p><img alt="" src="../2020-07-19-00-01-20.png" /></p>
<p>当我们配置了istio等service mesh组件后，可以通过kiali等组件进行链路分析</p>
<p><img alt="" src="../2020-07-19-00-16-07.png" /></p>
<h2 id="_13">可能性改进</h2>
<p>目前的方案因为网络环境有限，没有公网ip，push触发没有配置。</p>
<p>又因为时间有限，只是保证了运行时架构以及用户程序（由k8s保证）的ha，如果时间允许，还可以有很多改善的玩法， <br />
比如jenkins以及nexus在k8s内的ha部署，jenkins复用k8s机制动态起worker等。</p>
<p>同时，时间允许的化也可以配置下promethues配合loki或者elk等完成监控以及日志的监控与分析等。</p>
<p>另外，在k8s环境下有更加云原生的JenkinsX也可以考虑使用。</p>
<h2 id="_14">后记</h2>
<p>这样一份这么完整的方案，竟然没有一次通过。</p>
<p>给的理由是, 部署方案放在文档里，没有独立写出自动化的脚本。</p>
<p>如果是jenkins，nexus这样，因为文中给出的是docker简易部署模式，都是一行命令行而以，放哪里其实区别不大。<br />
如果是k8s的部署，这里给的是ha部署，要求这都一键部署，我这方案都可以当产品卖钱了。</p>
<p>整体对tw好感度骤然下降。</p>
<div id="disqus_thread"></div>

<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://devs-wiki.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../../../.."}})</script>
      
    
  </body>
</html>